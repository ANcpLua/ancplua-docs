---
title: 'Testing'
description: 'xUnit v3 with Microsoft Testing Platform and integration test base classes.'
icon: 'flask'
---

The Test SDK (`ANcpLua.NET.Sdk.Test`) provides xUnit v3 with Microsoft Testing Platform and injects base classes for integration testing.

## Microsoft Testing Platform (MTP)

The SDK uses [xUnit v3](https://xunit.net/docs/getting-started/v3/cmdline) with [Microsoft Testing Platform](https://learn.microsoft.com/en-us/dotnet/core/testing/microsoft-testing-platform-overview) instead of VSTest.

### Auto-Configuration

MTP requires test projects to output executables. **The SDK handles this automatically** when you reference `xunit.v3.mtp-v2`:

```xml
<!-- SDK auto-detects this and sets OutputType=Exe -->
<PackageReference Include="xunit.v3.mtp-v2" />
```

### CLI Syntax

MTP uses different command syntax than VSTest:

<CodeGroup>
    ```bash .NET 10+ (MTP native)
    # Run all tests
    dotnet test

    # Run with filter (no -- separator needed)
    dotnet test --filter-method "*MyTest*"

    # List tests
    dotnet test --list-tests

    # Generate TRX report
    dotnet test --report-trx
    ```

    ```bash .NET 8/9 (MTP opt-in)
    # Requires -- separator to pass args to test executable
    dotnet test -- --filter-method "*MyTest*"
    dotnet test -- --list-tests
    ```

    ```bash VSTest syntax (BANNED)
    # These do NOT work with MTP - exit code 5
    dotnet test --filter "FullyQualifiedName~MyTest"
    dotnet test --logger trx
    ```

</CodeGroup>

<Warning>
  **VSTest syntax causes exit code 5 with MTP.** Use `--filter-method` instead
  of `--filter "FQN~"` and `--report-trx` instead of `--logger trx`.
</Warning>

<Note>
  .NET 10 includes native MTP support via `global.json`. The `--` separator is
  only needed for .NET 8/9 with explicit MTP opt-in.
</Note>

### Troubleshooting

| Exit Code | Cause                 | Fix                                                                |
| --------- | --------------------- | ------------------------------------------------------------------ |
| 5         | Unknown CLI option    | Use MTP syntax (`--filter-method`), not VSTest (`--filter "FQN~"`) |
| 8         | Zero tests discovered | Check filter pattern; ensure test methods are public               |
| N/A       | Tests not found       | Verify `xunit.v3.mtp-v2` reference; SDK sets `OutputType=Exe`      |

## xUnit v3 TestContext

xUnit v3 replaces constructor-injected `ITestOutputHelper` with ambient `TestContext`. Access test output anywhere without passing it through constructor chains.

### Before vs After

| Aspect                     | xUnit v2 (Before)         | xUnit v3 (After)              |
| -------------------------- | ------------------------- | ----------------------------- |
| Test constructor params    | fixture, testOutputHelper | fixture                       |
| Fields to store            | 2                         | 1                             |
| Builder constructor params | 4                         | 3                             |
| Boilerplate per test class | ~3 lines                  | 0                             |
| How output is accessed     | Passed through chain      | Ambient `TestContext.Current` |

### Migration Example

<CodeGroup>
    ```csharp xUnit v2 (before)
    public class MyApiTests : IntegrationTestBase<Program>
    {
        private readonly ITestOutputHelper _output;
        private readonly MyFixture _fixture;

        public MyApiTests(MyFixture fixture, ITestOutputHelper output)
    {
        _fixture = fixture;
        _output = output;
    }

        [Fact]
        public async Task Get_ReturnsSuccess()
    {
        _output.WriteLine("Starting test...");
        var response = await Client.GetAsync("/api/items");
        response.EnsureSuccessStatusCode();
    }

    }

    ````

    ```csharp xUnit v3 (after)
    public class MyApiTests : IntegrationTestBase<Program>
    {
        private readonly MyFixture _fixture;

        public MyApiTests(MyFixture fixture) => _fixture = fixture;

        [Fact]
        public async Task Get_ReturnsSuccess()
    {
        TestContext.Current.TestOutputHelper.WriteLine("Starting test...");
        var response = await Client.GetAsync("/api/items");
        response.EnsureSuccessStatusCode();
    }
    }
    ````

</CodeGroup>

<Tip>
  `TestContext.Current` is available anywhere during test execution - in test
  methods, helper classes, or builder patterns - without explicit parameter
  passing.
</Tip>

## IntegrationTestBase

In-memory TestServer for fast API testing.

````csharp
public class MyApiTests : IntegrationTestBase<Program>
    {
        [Fact]
        public async Task Get_ReturnsSuccess()
    {
        var response = await Client.GetAsync("/api/items");
        response.EnsureSuccessStatusCode();
    }
    }
    ```

    Uses `WebApplicationFactory<TProgram>` internally.

    ## KestrelTestBase

    Real Kestrel server for HTTP/2, WebSockets, SSE, or Playwright.

    ```csharp
    public class WebSocketTests : KestrelTestBase<Program>
    {
        [Fact]
        public async Task WebSocket_ConnectsSuccessfully()
    {
        var ws = new ClientWebSocket();
        await ws.ConnectAsync(new Uri($"{BaseAddress}/ws"), CancellationToken.None);
    }
    }
    ```

    Starts on random port via `UseKestrel(0)`.

    ## FakeLogger

    See [Extensions](/sdk/extensions) for `FakeLogCollector` test helpers.
````
